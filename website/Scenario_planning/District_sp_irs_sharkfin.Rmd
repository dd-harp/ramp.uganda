---
title: "Working with Models"
output: html_document
---

[`ramp.uganda`](../index.html)

***

load libraries 
This sets locations for `Box/RAMP` and `ramp.uganda` 
```{r}
library(ramp.xds)
library(dplyr)
library(ramp.uganda)
library(ramp.work)
library(ramp.control)
attach(yaml::read_yaml("../../my_paths.yaml")) 
``` 

load district data from district dir
```{r,eval=F}
 load("C:/Users/Admin/Documents/ramp.uganda/data/district_dir.rda")
# #load("C:/Users/doree/Documents/Github/ramp.uganda/data/district_dir.rda")
 dist_name <- sort(district_dir$district_name)
```



Get IRS timelines for all districts that recieved IRS and select only those values that are positive for Post-2015
```{r}
FirstYear <-2015
irs_time_full <- list()
no_irs <- c()

for (j in dist_name) {
  dates <- get_irs_jdates(j, FirstYear)

  if (!is.null(dates) && length(dates) > 0 && any(dates > 0)) {
    irs_time_full[[j]] <- sort(dates[dates > 0])
  } else {
    no_irs <- c(no_irs, j)
  }
}
#irs_time <-  irs_time_full[c(4, 7,8,9,10,11,13,14,15,25,31,34)]
irs_time <- irs_time_full # irs_time_full[c(34)]# for a single district Torroro
```

 Extract the district names from the irs_time data
```{r}
irs_dist <- list()
for (i in 1:length(irs_time))
  irs_dist[[i]]<- names(irs_time)[i]
```

Get fitted models to pfpr data for all the districts
```{r, eval=F}
directory <- paste(box_dir, "models", sep = "") 
Lambda_files <- list.files(path = directory, pattern = "*_Lambda_sis.rds", full.names = TRUE)
clean_name <- function(name) {
  tolower(gsub(" ", "_", name))
}
cleaned_dists <- sapply(irs_dist, clean_name)
# Find indices in eir_files that contain each cleaned district name
matched_indices <- sapply(cleaned_dists, function(dname) {
  which(grepl(dname, Lambda_files))
})

Lambda_files_irs <- Lambda_files[matched_indices]
```


Get pfpr data by irs district 
```{r,eval=F}
load("C:/Users/Admin/Documents/ramp.uganda/data/district_dir.rda")
#load("C:/Users/doree/Documents/Github/ramp.uganda/data/district_dir.rda")
#dist_name <-irs_dist
data_list = list()
for(i in irs_dist)
  data_list[[i]] <- get_district_pfpr(i)
```


Get fitted models to pfpr data for all the itn district
```{r, eval=F}
fitted_mod <- list()
for (i in 1:length(irs_dist)) {
  fitted_mod[[i]] <- readRDS(Lambda_files_irs[i])
  fitted_mod[[i]]$nHostSpecies <- 1
fitted_mod[[i]]$nVectorSpecies <- 1

}
valsf <- get_XH(fitted_mod[[2]])
with(valsf, plot(fitted_mod[[2]]$outputs$time/365+FirstYear, true_pr, ylab = "PR",lwd=2, xlab = "Time", main=unique(data_list[[2]]$district_name), type = "l", ylim = c(0,1), col="darkred"))
  #with(vals, lines(time/365+FirstYear, true_pr, lwd=2,  col="darkblue"))
  with(data_list[[2]], lines(jdate/365+FirstYear, pfpr, pch=16,type = "o", col="darkblue"))
  add_irs_history(unique(data_list[[2]]$district_name))
```


 Profile for obtaining plots and effect sizes

```{r, fig.height=8, fig.width=11}
profile_irs = function(i, model_list, data_list){
mod_file <- model_list[[i]]
data <- data_list[[i]]

mod_for_cast <- last_to_inits(mod_file)
mod_for_cast$nHostSpecies <- 1
mod_for_cast$nVectorSpecies <- 1
mod_for_cast <- setup_other_variables(mod_for_cast)
mod_for_cast <- forecast_spline_Lambda(mod_for_cast, 5, x_last = 1)
tt <- seq(0, ceiling(max(data$jdate) / 365) * 365 + (5 * 365), length.out = 200)

mod_for_cast <- xds_solve(mod_for_cast, Tmax = max(tt))

vals_for <- get_XH(mod_for_cast)
time_years <- mod_for_cast$outputs$time / 365 + FirstYear
t <- time_years

test_irs = list(
t_init = c(60, 240, 420, 785)+730,
irs_type = c("bendiocarb", "bendiocarb", "actellic", "sumishield"),
coverage = c(.9, .85, .9, .9),
zap = c(.95, .8, .4))

effect <- function(t) {
  max_eff <- 0.9
  decay_rate <- 0.01
  return(max_eff / (1 + exp(decay_rate * (t - 180))))
}

mod_file <- setup_other_variables(mod_file)
multi4 = setup_irs_multiround(opts = test_irs)
F4r <- make_function(multi4)
#simple <- setup_irs_effectsizes_simple(mod_file)
mod_irs <- setup_irs(mod_for_cast, effectsizes_name = "none", coverage_name = "func", coverage_opts = list(mx=1, trend_par = multi4))
#mod_irs <- xds_solve(mod_irs, Tmax=365*8, dt=1)





mod_for_cast_cov <- xds_solve(mod_irs, max(tt))
vals_cov <- get_XH(mod_for_cast_cov)

  df <- data.frame(
    Year = t,
    Original_PR = round(vals_for$true_pr,4),
    irs_PR = round(vals_cov$true_pr, 4)
  )
  df <- df[df$Year >= 2020,]

  plot(df$Year, df$Original_PR, type = "l", lwd = 2, col = "blue",
       ylim = c(0, 1), ylab = "Parasite Rate (PR)", xlab = "Year",
       main = paste(unique(data$district_name)))

  lines(df$Year, df$irs_PR, col = "darkred", lwd = 2)
  with(data, lines(jdate / 365 + FirstYear, pfpr, type = "o", col = "darkblue"))


}
```

```{r}
for(i in 30)
  profile_irs(i, fitted_mod, data_list)
```
